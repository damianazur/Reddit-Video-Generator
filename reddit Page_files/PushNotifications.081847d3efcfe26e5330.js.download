(window.webpackJsonp=window.webpackJsonp||[]).push([["PushNotifications"],{"./src/graphql/operations/RegisterWebPushToken.json":function(e){e.exports={id:"197650c1946c"}},"./src/lib/timezone/index.ts":function(e,t,n){"use strict";n.d(t,"a",function(){return o}),n.d(t,"b",function(){return a}),n.d(t,"e",function(){return c}),n.d(t,"d",function(){return u}),n.d(t,"f",function(){return d}),n.d(t,"g",function(){return l}),n.d(t,"c",function(){return f});var r=n("./src/lib/constants/index.ts"),i=n("./src/reddit/models/PostCreationForm/index.ts"),s=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(r=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(c){i=!0,s=c}finally{try{!r&&a.return&&a.return()}finally{if(i)throw s}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();const o="America/Los_Angeles",a=()=>{let e;try{e=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(t){}return"Asia/Calcutta"===e&&(e="Asia/Kolkata"),e||void 0},c=e=>{const t=Math.abs(e),n=t%60;return`${e>0?"-":"+"}${("0"+Math.floor(t/60)).slice(-2)}:${("0"+n).slice(-2)}`},u=(e,t)=>{const n=t||Date.now(),i={year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",timeZoneName:"short",hour12:!1,timeZone:e};let o="";try{o=new Intl.DateTimeFormat("en-US",i).format(new Date(n))}catch(y){return}var a=o.replace(", "," ").split(" "),c=s(a,3);const u=c[0],d=c[1],l=c[2];var f=u.trim().split("/").map(Number),p=s(f,3);const b=p[0],m=p[1],g=p[2];var v=d.trim().split(":").map(Number),j=s(v,3);const h=j[0],O=j[1],w=j[2],k=Date.UTC(g,b-1,m,h,O,w),_=new Date(n).setMilliseconds(0)-k;return{abbreviation:l,offset:Math.round(_/r.cb)}},d=e=>{var t=e.slice(0,19).split("T"),n=s(t,2);const r=n[0],i=n[1];var o=r.split("-").map(Number),a=s(o,3);const c=a[0],u=a[1],d=a[2];var l=i.split(":").map(Number),f=s(l,3);const p=f[0],b=f[1];var m=f[2];return new Date(c,u-1,d,p,b,void 0===m?0:m)},l=e=>{const t=new Date(e);return t.setMinutes(t.getMinutes()-t.getTimezoneOffset()),t.toISOString().slice(0,16)},f=e=>{if(e&&e.eventInfo){var t=e.eventInfo;const n=t.eventStart,s=t.eventEnd;return{startDate:l(new Date(n*r.Cb)),endDate:l(new Date(s*r.Cb)),submitTime:i.i.Now,timezoneName:a()||o}}}},"./src/reddit/actions/notifications/index.ts":function(e,t,n){"use strict";n.r(t);var r=n("./src/config.ts"),i=n("./src/lib/browser/isIncognito.ts"),s=n("./src/lib/constants/index.ts"),o=n("./src/lib/localStorageAvailable/index.ts"),a=n("./src/reddit/actions/notifications/constants.ts"),c=n("./src/reddit/actions/notifications/state.ts"),u=n("./src/reddit/actions/notifications/utils.ts"),d=n("./src/reddit/actions/toaster.ts"),l=n("./src/graphql/operations/RegisterWebPushToken.json"),f=n("./src/lib/makeGqlRequest/index.ts"),p=n("./src/lib/timezone/index.ts");var b=n("./src/reddit/helpers/trackers/notifications.ts"),m=n("./src/reddit/i18n/utils.ts"),g=n("./src/reddit/models/Toast/index.ts"),v=n("./src/reddit/selectors/experiments/dnPrePrompt.ts"),j=n("./src/reddit/selectors/notificationPrefs.ts"),h=n("./src/reddit/selectors/user.ts");n.d(t,"getBrowserNotificationPermission",function(){return w}),n.d(t,"resetPermissionRequestClosed",function(){return k}),n.d(t,"isBrowserSubscribedForPushNotifications",function(){return _}),n.d(t,"initializeServiceWorkerChannel",function(){return P}),n.d(t,"requestNotificationsPermissions",function(){return N}),n.d(t,"subscribeForPNs",function(){return x}),n.d(t,"unsubscribeFromPNs",function(){return D});const O=4*s.K,w=()=>{const e=Object(o.a)()&&"1"===localStorage.getItem("notification-permission-request-closed");return"granted"===Notification.permission?a.a.Granted:"denied"===Notification.permission?a.a.Denied:e?a.a.Closed:a.a.Default},k=()=>!!Object(o.a)()&&(localStorage.removeItem("notification-permission-request-closed"),!0),_=async()=>{let e;try{e=await navigator.serviceWorker.register("/sw.js")}catch(t){return!1}return null!==await e.pushManager.getSubscription()},y=e=>{navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({command:"registerClient",v2EventBoilerPlate:b.b(e)})};let S=!1;const P=async e=>{if(S)return;if(S=!0,Object(u.a)(e)!==a.f.NotificationsSupported)return;try{await navigator.serviceWorker.register("/sw.js")}catch(t){return}navigator.serviceWorker.addEventListener("message",t=>{"registerWithServiceWorker"===t.data.command&&y(e)}),y(e)},N=(e,t)=>async(n,r,s)=>{const c=r();if(await Object(i.a)())return;const d=Object(v.a)(c);if(!Object(h.G)(c)&&!d)return;if(await P(c),Object(o.a)()){const t=localStorage.getItem("push-token-last-refresh-ms"),n=(new Date).getTime();if(!e&&t&&parseInt(t)+O>n)return;localStorage.setItem("push-token-last-refresh-ms",n.toString())}b.l(c);const l=Object(u.a)(c);if(l===a.f.BrowserUnsupported)return void b.k(c,"unsupported_browser");if(l===a.f.LocalStorageUnavailable)return void b.k(c,"local_storage_unavailable");if(l===a.f.NotAllRequiredAPIsSupported)return void b.k(c,"not_all_push_apis_supported");if("denied"===Notification.permission)return n(Object(a.p)()),void b.k(c,"already_denied");if("granted"===Notification.permission)return n(Object(a.q)()),void n(x());const f=localStorage.getItem("notification-permission-request-closed");if(!t&&f&&"1"===f)return void b.k(c,"notification_permission_request_closed");const p=localStorage.getItem(a.i);if(t||!p||p!==a.j)if(t||!d||Object(j.c)(c)||(n(Object(a.s)()),!Object(v.c)(d)))switch(n(Object(a.r)()),b.j(c),await Notification.requestPermission()){case"granted":n(Object(a.q)()),n(x()),b.c(c);break;case"denied":n(Object(a.p)()),b.d(c);break;default:n(Object(a.p)()),b.e(c),localStorage.setItem("notification-permission-request-closed","1")}else b.i(r());else b.k(c,"preprompt_closed")},x=e=>async(t,n,i)=>{const s=n();try{const a=await navigator.serviceWorker.register("/sw.js");let u=await a.pushManager.getSubscription();if(!u){const e={userVisibleOnly:!0,applicationServerKey:(e=>{const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),r=new Uint8Array(n.length);for(let i=0;i<n.length;++i)r[i]=n.charCodeAt(i);return r})(r.a.pushNotificationApplicationServerKey)};u=await a.pushManager.subscribe(e)}Object(c.c)();const v=await((e,t,n)=>{const r={pushToken:JSON.stringify(n),timezoneName:Object(p.b)()||p.a,timestamp:(new Date).toISOString(),language:"en_us"};return Object(f.a)(e,Object.assign({},l,{variables:r}))})(i.gqlContext(),n(),u),j=v.body.data.registerWebPushToken;v.ok?j&&!j.ok?b.k(s,"registration_failed_in_gql"):(b.m(s),e&&t(Object(d.e)({kind:g.b.SuccessCommunity,text:Object(m.c)("Changes saved")}))):b.k(s,"registration_failed_generally")}catch(o){b.k(s,"registration_failed_uncaught_exception"),console.error(o)}},D=e=>async(t,n,r)=>{try{const n=await navigator.serviceWorker.register("/sw.js"),r=await n.pushManager.getSubscription();r&&(r.unsubscribe(),Object(c.c)(),e&&t(Object(d.e)({kind:g.b.SuccessCommunity,text:Object(m.c)("Changes saved")})))}catch(i){}}},"./src/reddit/helpers/trackers/notifications.ts":function(e,t,n){"use strict";n.d(t,"j",function(){return c}),n.d(t,"c",function(){return u}),n.d(t,"d",function(){return d}),n.d(t,"e",function(){return l}),n.d(t,"i",function(){return f}),n.d(t,"g",function(){return p}),n.d(t,"h",function(){return b}),n.d(t,"l",function(){return g}),n.d(t,"m",function(){return v}),n.d(t,"k",function(){return j}),n.d(t,"b",function(){return h}),n.d(t,"a",function(){return y}),n.d(t,"f",function(){return D});var r=n("./src/reddit/models/PushNotification/index.ts"),i=n("./src/reddit/selectors/telemetry.ts"),s=n("./src/telemetry/index.ts");const o=e=>Object.assign({},i.defaults(e),{noun:"desktop_notification_permissions"}),a=e=>Object.assign({},i.defaults(e),{noun:"desktop_notif_preprompt_permissions"}),c=e=>{Object(s.a)(Object.assign({},o(e),{action:"view",source:"popup"}))},u=e=>{Object(s.a)(Object.assign({},o(e),{action:"allow",source:"popup"}))},d=e=>{Object(s.a)(Object.assign({},o(e),{action:"block",source:"popup"}))},l=e=>{Object(s.a)(Object.assign({},o(e),{action:"close",source:"popup"}))},f=e=>{Object(s.a)(Object.assign({},a(e),{action:"view",source:"popup"}))},p=e=>{Object(s.a)(Object.assign({},a(e),{action:"allow",source:"popup"}))},b=e=>{Object(s.a)(Object.assign({},a(e),{action:"close",source:"popup"}))},m=(e,t,n)=>Object.assign({},i.defaults(e),{actionInfo:i.actionInfo(e,{success:t,reason:n}),noun:"desktop_push_token"}),g=e=>{Object(s.a)(Object.assign({},m(e,!0),{action:"request",source:"notifications"}))},v=e=>{Object(s.a)(Object.assign({},m(e,!0),{action:"register",source:"notifications"}))},j=(e,t)=>{Object(s.a)(Object.assign({},m(e,!1,t),{action:"bail",source:"notifications"}))},h=e=>Object.assign({},(e=>Object.assign({},i.defaults(e),{noun:"desktop_push_notification"}))(e),{notification:i.notification(e,void 0,void 0),action:void 0,source:"notifications",correlationId:void 0}),O=e=>(t,n)=>{Object(s.a)(Object.assign({},i.defaults(t),{action:(e=>e?"enable":"disable")(n),noun:e,source:"notifications"}))},w=O("chat_messages"),k=O("chat_requests"),_=O("comment_replies"),y=O("desktop_notification_permissions"),S=O("post_replies"),P=O("private_messages"),N=O("trending_posts"),x=O("username_mention"),D=(e,t,n)=>{switch(t){case r.a.ChatMessages:w(e,n),k(e,n);break;case r.a.TrendingPosts:N(e,n);break;case r.a.UnreadMessages:_(e,n),S(e,n),P(e,n),x(e,n)}}},"./src/reddit/models/PushNotification/index.ts":function(e,t,n){"use strict";var r;n.d(t,"a",function(){return r}),function(e){e.ChatMessages="chatMessages",e.TrendingPosts="trendingPosts",e.UnreadMessages="unreadMessages"}(r||(r={}))},"./src/reddit/selectors/experiments/dnPrePrompt.ts":function(e,t,n){"use strict";n.d(t,"a",function(){return s}),n.d(t,"b",function(){return o}),n.d(t,"c",function(){return a});var r=n("./src/reddit/constants/experiments.ts"),i=n("./src/reddit/helpers/chooseVariant/index.ts");const s=e=>{const t=Object(i.b)(e,{experimentEligibilitySelector:i.a,experimentName:r.s});return Object(r.ub)(t)?void 0:t},o=e=>e===r.r.DarkPrePrompt||e===r.r.DarkSystemDialogue,a=e=>e===r.r.DarkPrePrompt||e===r.r.PrePrompt}}]);
//# sourceMappingURL=PushNotifications.081847d3efcfe26e5330.js.map